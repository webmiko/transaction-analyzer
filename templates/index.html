<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            text-align: center;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .greeting {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .card-item h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .card-item .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .card-item .label {
            color: #666;
            font-size: 0.9em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        td.empty-cell {
            color: #333 !important;
            text-align: center;
            font-style: italic;
            background-color: transparent !important;
        }

        th {
            background: #f5f7fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .amount {
            font-weight: 600;
            color: #e74c3c;
        }

        .amount.positive {
            color: #27ae60;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .period-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .period-btn:hover {
            background: #667eea;
            color: white;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        h3 {
            color: #333;
            margin: 20px 0 10px 0;
        }

        .category-list {
            list-style: none;
            padding: 0;
        }

        .category-item {
            padding: 15px;
            margin: 10px 0;
            background: #f5f7fa;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            color: #333;
        }

        .currency-stocks {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
            .currency-stocks {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üí∞ –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h1>
            <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö</p>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('home')">–ì–ª–∞–≤–Ω–∞—è</button>
            <button class="tab" onclick="showTab('events')">–°–æ–±—ã—Ç–∏—è</button>
        </div>

        <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <div id="home" class="tab-content active">
            <div class="card">
                <div id="home-loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <div id="home-content" style="display: none;">
                    <div class="greeting" id="greeting"></div>
                    
                    <h2>üí≥ –ú–æ–∏ –∫–∞—Ä—Ç—ã</h2>
                    <div class="cards-grid" id="cards-grid"></div>

                    <h2>üìä –¢–æ–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>
                    <table id="transactions-table">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-body"></tbody>
                    </table>

                    <div class="currency-stocks" style="margin-top: 30px;">
                        <div class="card">
                            <h2>üí± –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h2>
                            <table id="currency-table">
                                <thead>
                                    <tr>
                                        <th>–í–∞–ª—é—Ç–∞</th>
                                        <th>–ö—É—Ä—Å</th>
                                    </tr>
                                </thead>
                                <tbody id="currency-body"></tbody>
                            </table>
                        </div>

                        <div class="card">
                            <h2>üìà –¶–µ–Ω—ã –∞–∫—Ü–∏–π</h2>
                            <table id="stocks-table">
                                <thead>
                                    <tr>
                                        <th>–ê–∫—Ü–∏—è</th>
                                        <th>–¶–µ–Ω–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="stocks-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="home-error" class="error" style="display: none;"></div>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–±—ã—Ç–∏–π -->
        <div id="events" class="tab-content">
            <div class="card">
                <div class="period-selector">
                    <button class="period-btn active" onclick="loadEvents('W')">–ù–µ–¥–µ–ª—è</button>
                    <button class="period-btn" onclick="loadEvents('M')">–ú–µ—Å—è—Ü</button>
                    <button class="period-btn" onclick="loadEvents('Y')">–ì–æ–¥</button>
                    <button class="period-btn" onclick="loadEvents('ALL')">–í—Å–µ</button>
                </div>
                
                <div class="date-range-selector" style="margin-top: 20px; padding: 20px; background: #f5f7fa; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìÖ –í—ã–±–æ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç</h3>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="color: #666; font-size: 0.9em; font-weight: 600;">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                            <input type="date" id="date-start" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; color: #333; background: white;">
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label style="color: #666; font-size: 0.9em; font-weight: 600;">–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞:</label>
                            <input type="date" id="date-end" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; color: #333; background: white;">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="period-btn" onclick="loadEventsByDateRange()" style="height: 42px; margin-top: 0;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>

                <div class="card-filter" style="margin-top: 20px; padding: 20px; background: #f5f7fa; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üí≥ –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ä—Ç–µ</h3>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px;">
                            <label style="color: #666; font-size: 0.9em; font-weight: 600;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É:</label>
                            <select id="card-filter" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; color: #333; background: white; cursor: pointer;" onchange="applyCardFilter()">
                                <option value="">–í—Å–µ –∫–∞—Ä—Ç—ã</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="events-loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <div id="events-content" style="display: none;">
                    <h2>üí∏ –†–∞—Å—Ö–æ–¥—ã</h2>
                    <div class="card-item" style="max-width: 300px; margin: 20px 0;">
                        <div class="label">–û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
                        <div class="value" id="expenses-total">0 ‚ÇΩ</div>
                    </div>

                    <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <ul class="category-list" id="expenses-main"></ul>

                    <h3 style="margin-top: 30px;">–ü–µ—Ä–µ–≤–æ–¥—ã –∏ –Ω–∞–ª–∏—á–Ω—ã–µ</h3>
                    <ul class="category-list" id="expenses-transfers"></ul>

                    <h2 style="margin-top: 40px;">üí∞ –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h2>
                    <div class="card-item" style="max-width: 300px; margin: 20px 0;">
                        <div class="label">–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</div>
                        <div class="value positive" id="income-total">0 ‚ÇΩ</div>
                    </div>

                    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</h3>
                    <ul class="category-list" id="income-main"></ul>

                    <div class="currency-stocks" style="margin-top: 30px;">
                        <div class="card">
                            <h2>üí± –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h2>
                            <table id="events-currency-table">
                                <thead>
                                    <tr>
                                        <th>–í–∞–ª—é—Ç–∞</th>
                                        <th>–ö—É—Ä—Å</th>
                                    </tr>
                                </thead>
                                <tbody id="events-currency-body"></tbody>
                            </table>
                        </div>

                        <div class="card">
                            <h2>üìà –¶–µ–Ω—ã –∞–∫—Ü–∏–π</h2>
                            <table id="events-stocks-table">
                                <thead>
                                    <tr>
                                        <th>–ê–∫—Ü–∏—è</th>
                                        <th>–¶–µ–Ω–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="events-stocks-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="events-error" class="error" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPeriod = 'M';

        function showTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'home') {
                loadHome();
            } else if (tabName === 'events') {
                loadEvents(currentPeriod);
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(num);
        }

        async function loadHome() {
            const loading = document.getElementById('home-loading');
            const content = document.getElementById('home-content');
            const error = document.getElementById('home-error');

            loading.style.display = 'block';
            content.style.display = 'none';
            error.style.display = 'none';

            try {
                const response = await fetch('/api/home');
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}: ${response.statusText}` }));
                    throw new Error(errorData.error || `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                document.getElementById('greeting').textContent = data.greeting || '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';

                // –ö–∞—Ä—Ç—ã
                const cardsGrid = document.getElementById('cards-grid');
                cardsGrid.innerHTML = '';
                if (data.cards && data.cards.length > 0) {
                    data.cards.forEach(card => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'card-item';
                        cardDiv.innerHTML = `
                            <h3>–ö–∞—Ä—Ç–∞ ****${card.last_digits}</h3>
                            <div class="value">${formatCurrency(card.total_spent)}</div>
                            <div class="label">–ö–µ—à–±—ç–∫: ${formatCurrency(card.cashback)}</div>
                        `;
                        cardsGrid.appendChild(cardDiv);
                    });
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–æ–±—ã—Ç–∏–π
                    loadCardsList(data.cards);
                } else {
                    cardsGrid.innerHTML = '<p style="color: #333;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ä—Ç–∞–º</p>';
                }

                // –¢–æ–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                const transactionsBody = document.getElementById('transactions-body');
                transactionsBody.innerHTML = '';
                if (data.top_transactions && data.top_transactions.length > 0) {
                    data.top_transactions.forEach(trans => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="color: #333;">${trans.date}</td>
                            <td class="amount" style="color: #e74c3c;">${formatCurrency(trans.amount)}</td>
                            <td style="color: #333;">${trans.category}</td>
                            <td style="color: #333;">${trans.description}</td>
                        `;
                        transactionsBody.appendChild(row);
                    });
                } else {
                    transactionsBody.innerHTML = '<tr><td colspan="4" class="empty-cell" style="color: #333 !important;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td></tr>';
                }

                // –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç
                const currencyBody = document.getElementById('currency-body');
                currencyBody.innerHTML = '';
                if (data.currency_rates && data.currency_rates.length > 0) {
                    data.currency_rates.forEach(rate => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="color: #333;">${rate.currency}</td>
                            <td style="color: #333;">${formatNumber(rate.rate)}</td>
                        `;
                        currencyBody.appendChild(row);
                    });
                } else {
                    currencyBody.innerHTML = '<tr><td colspan="2" class="empty-cell" style="color: #333 !important;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }

                // –¶–µ–Ω—ã –∞–∫—Ü–∏–π
                const stocksBody = document.getElementById('stocks-body');
                stocksBody.innerHTML = '';
                if (data.stock_prices && data.stock_prices.length > 0) {
                    data.stock_prices.forEach(stock => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="color: #333;">${stock.stock}</td>
                            <td style="color: #333;">$${formatNumber(stock.price)}</td>
                        `;
                        stocksBody.appendChild(row);
                    });
                } else {
                    stocksBody.innerHTML = '<tr><td colspan="2" class="empty-cell" style="color: #333 !important;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }

                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                const errorMessage = err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö';
                error.textContent = `–û—à–∏–±–∫–∞: ${errorMessage}`;
                error.style.display = 'block';
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', err);
            }
        }

        async function loadEvents(period, startDate = null, endDate = null, cardFilter = null) {
            currentPeriod = period;
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –ø–µ—Ä–∏–æ–¥–∞ (–µ—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É)
            if (event && event.target) {
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }

            const loading = document.getElementById('events-loading');
            const content = document.getElementById('events-content');
            const error = document.getElementById('events-error');

            loading.style.display = 'block';
            content.style.display = 'none';
            error.style.display = 'none';

            try {
                let url = `/api/events/${period}`;
                const params = [];
                if (startDate && endDate) {
                    params.push(`start_date=${startDate}`, `end_date=${endDate}`);
                }
                if (cardFilter) {
                    params.push(`card=${encodeURIComponent(cardFilter)}`);
                }
                if (params.length > 0) {
                    url += `?${params.join('&')}`;
                }
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}: ${response.statusText}` }));
                    throw new Error(errorData.error || `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // –†–∞—Å—Ö–æ–¥—ã
                document.getElementById('expenses-total').textContent = 
                    formatCurrency(data.expenses?.total_amount || 0);

                // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
                const expensesMain = document.getElementById('expenses-main');
                expensesMain.innerHTML = '';
                if (data.expenses?.main && data.expenses.main.length > 0) {
                    data.expenses.main.forEach(cat => {
                        const li = document.createElement('li');
                        li.className = 'category-item';
                        li.innerHTML = `
                            <span class="category-name">${cat.category}</span>
                            <span class="amount">${formatCurrency(cat.amount)}</span>
                        `;
                        expensesMain.appendChild(li);
                    });
                }

                // –ü–µ—Ä–µ–≤–æ–¥—ã –∏ –Ω–∞–ª–∏—á–Ω—ã–µ
                const expensesTransfers = document.getElementById('expenses-transfers');
                expensesTransfers.innerHTML = '';
                if (data.expenses?.transfers_and_cash && data.expenses.transfers_and_cash.length > 0) {
                    data.expenses.transfers_and_cash.forEach(cat => {
                        const li = document.createElement('li');
                        li.className = 'category-item';
                        li.innerHTML = `
                            <span class="category-name">${cat.category}</span>
                            <span class="amount">${formatCurrency(cat.amount)}</span>
                        `;
                        expensesTransfers.appendChild(li);
                    });
                }

                // –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
                document.getElementById('income-total').textContent = 
                    formatCurrency(data.income?.total_amount || 0);

                // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π
                const incomeMain = document.getElementById('income-main');
                incomeMain.innerHTML = '';
                if (data.income?.main && data.income.main.length > 0) {
                    data.income.main.forEach(cat => {
                        const li = document.createElement('li');
                        li.className = 'category-item';
                        li.innerHTML = `
                            <span class="category-name">${cat.category}</span>
                            <span class="amount positive">${formatCurrency(cat.amount)}</span>
                        `;
                        incomeMain.appendChild(li);
                    });
                }

                // –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç
                const eventsCurrencyBody = document.getElementById('events-currency-body');
                eventsCurrencyBody.innerHTML = '';
                if (data.currency_rates && data.currency_rates.length > 0) {
                    data.currency_rates.forEach(rate => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="color: #333;">${rate.currency}</td>
                            <td style="color: #333;">${formatNumber(rate.rate)}</td>
                        `;
                        eventsCurrencyBody.appendChild(row);
                    });
                } else {
                    eventsCurrencyBody.innerHTML = '<tr><td colspan="2" class="empty-cell" style="color: #333 !important;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }

                // –¶–µ–Ω—ã –∞–∫—Ü–∏–π
                const eventsStocksBody = document.getElementById('events-stocks-body');
                eventsStocksBody.innerHTML = '';
                if (data.stock_prices && data.stock_prices.length > 0) {
                    data.stock_prices.forEach(stock => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="color: #333;">${stock.stock}</td>
                            <td style="color: #333;">$${formatNumber(stock.price)}</td>
                        `;
                        eventsStocksBody.appendChild(row);
                    });
                } else {
                    eventsStocksBody.innerHTML = '<tr><td colspan="2" class="empty-cell" style="color: #333 !important;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }

                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                const errorMessage = err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö';
                error.textContent = `–û—à–∏–±–∫–∞: ${errorMessage}`;
                error.style.display = 'block';
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–±—ã—Ç–∏–π:', err);
            }
        }

        async function loadEventsByDateRange() {
            const startDateInput = document.getElementById('date-start');
            const endDateInput = document.getElementById('date-end');
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (!startDate || !endDate) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã (–Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞)');
                return;
            }
            
            if (startDate > endDate) {
                alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –∫–æ–Ω—Ü–∞');
                return;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–∏–æ–¥–∞
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É
            const cardFilter = document.getElementById('card-filter').value;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º –¥–∞—Ç
            await loadEvents('CUSTOM', startDate, endDate, cardFilter || null);
        }

        function loadCardsList(cards) {
            const cardFilterSelect = document.getElementById('card-filter');
            if (!cardFilterSelect) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const currentValue = cardFilterSelect.value;
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ (–∫—Ä–æ–º–µ –æ–ø—Ü–∏–∏ "–í—Å–µ –∫–∞—Ä—Ç—ã")
            cardFilterSelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ä—Ç—ã</option>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—ã
            if (cards && cards.length > 0) {
                cards.forEach(card => {
                    const option = document.createElement('option');
                    option.value = card.last_digits;
                    option.textContent = `–ö–∞—Ä—Ç–∞ ****${card.last_digits}`;
                    cardFilterSelect.appendChild(option);
                });
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (currentValue) {
                cardFilterSelect.value = currentValue;
            }
        }

        function applyCardFilter() {
            const cardFilter = document.getElementById('card-filter').value;
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Å —Ç–µ–∫—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –∫–∞—Ä—Ç–µ
            loadEvents(currentPeriod, null, null, cardFilter || null);
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', () => {
            loadHome();
        });
    </script>
</body>
</html>

